{% extends "base.html" %}
{% block title %}End{% endblock %}
{% block content %}
<style>
  .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: var(--shadow); margin-bottom: 14px; }
  .panel-header { display: flex; justify-content: space-between; gap: 10px; align-items: center; flex-wrap: wrap; }
  .badge { padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 0.9rem; }
  .badge-done { background: rgba(34,197,94,0.15); color: #15803d; border: 1px solid rgba(34,197,94,0.3); }
  .badge-pending { background: rgba(234,179,8,0.18); color: #92400e; border: 1px solid rgba(234,179,8,0.35); }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 8px; border: 1px solid var(--border); font-size: 0.92rem; }
  thead { background: rgba(15,139,141,0.08); }
  .btn-toggle { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: rgba(15,139,141,0.1); cursor: pointer; }
  .btn-toggle.on { background: linear-gradient(120deg, var(--accent), #18b0ac); color: #fff; border: none; }
  .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); }
  .table-wrap { overflow: auto; border-radius: 12px; border: 1px solid var(--border); }
</style>

<h1 class="h4 mb-2">End</h1>
<p class="subtitle" style="color:var(--muted);">Classes groupees par prestation avec objectifs (effectif / femmes) et bouton ON/OFF pour basculer le statut des classes.</p>

{% if prestations %}
  {% for p in prestations %}
    {% with done=p.classes_terminees == p.total_classes and p.total_apprenants|default:0 >= p.effectif_a_former %}
    <div class="panel" data-prestation-id="{{ p.id }}">
      <div class="panel-header">
        <div>
          <div style="font-weight:800;">Prestation {{ p.code }} - {{ p.prestataire }}</div>
          <div class="subtitle">Formation : {{ p.formation }} | Beneficiaire : {{ p.beneficiaire|default:"-" }}</div>
          <div class="subtitle">
            Objectifs : {{ p.effectif_a_former }} personnes / {{ p.femmes }} femmes - Realise : {{ p.total_apprenants }} apprenants
          </div>
        </div>
        <div>
          <span class="badge {% if done %}badge-done{% else %}badge-pending{% endif %}" data-prestation-state>{{ done|yesno:"Terminee,En cours" }}</span>
          <div class="subtitle" style="text-align:right;">Classes terminees : {{ p.classes_terminees }} / {{ p.total_classes }}</div>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Classe</th>
              <th>Lieu</th>
              <th>Statut</th>
              <th>Apprenants</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for classe in p.classes.all %}
            <tr data-classe-id="{{ classe.id }}">
              <td>{{ classe.code }} - {{ classe.intitule_formation }}</td>
              <td>{{ classe.lieu|default:"-" }}</td>
              <td><span class="pill" data-classe-statut>{{ classe.get_statut_display }}</span></td>
              <td>{{ classe.apprenants_count|default:0 }}</td>
              <td><button type="button" class="btn-toggle {% if classe.statut == 'termine' %}on{% endif %}" data-url="{% url 'class_toggle_status' classe.id %}" data-statut="{{ classe.statut }}">ON/OFF</button></td>
            </tr>
            {% empty %}
            <tr><td colspan="5" style="text-align:center; color:var(--muted);">Aucune classe</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endwith %}
  {% endfor %}
{% else %}
  <div class="alert alert-info">Aucune prestation.</div>
{% endif %}

<script>
  (function() {
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return "";
    }
    const csrfToken = getCookie("csrftoken");

    function updatePrestationState(prestationId, payload) {
      const container = document.querySelector(`[data-prestation-id="${prestationId}"]`);
      if (!container) return;
      const badge = container.querySelector("[data-prestation-state]");
      const info = container.querySelector(".subtitle:last-child");
      if (badge) {
        const done = !!payload.prestation_terminee;
        badge.textContent = done ? "Terminee" : "En cours";
        badge.classList.toggle("badge-done", done);
        badge.classList.toggle("badge-pending", !done);
      }
      if (info && payload.classes_terminees !== undefined && payload.total_classes !== undefined) {
        info.textContent = `Classes terminees : ${payload.classes_terminees} / ${payload.total_classes}`;
      }
      const objLine = container.querySelector(".panel-header .subtitle:nth-of-type(2)");
      if (objLine && payload.total_apprenants !== undefined && payload.objectif_effectif !== undefined) {
        const femmesCible = payload.femmes_cible !== undefined ? payload.femmes_cible : "-";
        objLine.textContent = `Objectifs : ${payload.objectif_effectif} personnes / ${femmesCible} femmes - Realise : ${payload.total_apprenants} apprenants`;
      }
    }

    async function toggleClasse(button) {
      const url = button.getAttribute("data-url");
      if (!url) return;
      button.disabled = true;
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": csrfToken,
            "Accept": "application/json",
          },
        });
        if (!res.ok) throw new Error("bad status");
        const data = await res.json();
        if (!data.ok) throw new Error("bad payload");
        const row = button.closest("tr[data-classe-id]");
        if (row) {
          const pill = row.querySelector("[data-classe-statut]");
          if (pill) {
            pill.textContent = data.statut_label || data.statut;
          }
        }
        button.classList.toggle("on", data.statut === "termine");
        button.dataset.statut = data.statut;
        updatePrestationState(data.prestation_id, data);
      } catch (err) {
        alert("Impossible de mettre a jour le statut.");
      } finally {
        button.disabled = false;
      }
    }

    document.querySelectorAll(".btn-toggle").forEach((btn) => {
      btn.addEventListener("click", () => toggleClasse(btn));
    });
  })();
</script>
{% endblock %}
